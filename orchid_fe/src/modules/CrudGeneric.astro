---
import LayoutSidebar from '@/app/LayoutSidebar.astro';
import type { Endpoint } from '@/types/api';
import type { EntityConfig, BaseEntity } from '@/entities/types';
import { getEntityConfig } from '@/entities';
import { createCrudService } from '@/services/crud/crud.service';

interface Props {
  entityType: Endpoint;
  class?: string;
}

const { entityType, class: clazz } = Astro.props;

try {
  // Get entity configuration
  const config = await getEntityConfig(entityType);
  
  // Create CRUD service instance with proper typing
  const crudService = createCrudService(config as any);

  // Fetch initial data
  const initialData = await crudService.list({
    page: 1,
    limit: (config as any).pagination.defaultPageSize
  });

  // Generate HTML table dynamically
  function generateTable(data: any[], columns: any[]) {
    let tableHTML = `
      <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              <th scope="col" class="p-4">
                <div class="flex items-center">
                  <input id="checkbox-all-search" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                  <label for="checkbox-all-search" class="sr-only">checkbox</label>
                </div>
              </th>`;

    // Add column headers
    columns.forEach(column => {
      tableHTML += `<th scope="col" class="px-6 py-3">${column.label}</th>`;
    });

    tableHTML += `<th scope="col" class="px-6 py-3">Actions</th></tr></thead><tbody>`;

    // Add data rows
    data.forEach((item: any) => {
      tableHTML += `<tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
        <td class="w-4 p-4">
          <div class="flex items-center">
            <input id="checkbox-table-search-${item.id}" type="checkbox" value="${item.id}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
            <label for="checkbox-table-search-${item.id}" class="sr-only">checkbox</label>
          </div>
        </td>`;

      // Add column data
      columns.forEach(column => {
        const value = item[column.key as keyof BaseEntity];
        let displayValue = value;
        
        if (column.formatter) {
          displayValue = column.formatter(value, item);
        } else if (column.type === 'badge') {
          const variant = column.badgeVariant ? column.badgeVariant(value) : 'secondary';
          displayValue = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-${variant}-100 text-${variant}-800">${value}</span>`;
        }
        
        tableHTML += `<td class="px-6 py-4">${displayValue}</td>`;
      });

      // Add action buttons
      tableHTML += `<td class="px-6 py-4">
        <div class="flex space-x-2">
          <button type="button" class="action-btn" data-action="edit" data-id="${item.id}" class="text-blue-600 hover:text-blue-800">Edit</button>
          <button type="button" class="action-btn" data-action="delete" data-id="${item.id}" class="text-red-600 hover:text-red-800">Delete</button>
        </div>
      </td></tr>`;
    });

    tableHTML += `</tbody></table></div>`;
    return tableHTML;
  }

  // Generate pagination
  function generatePagination(currentPage: number, totalPages: number) {
    let paginationHTML = `<div class="flex items-center justify-between px-4 py-3 bg-white dark:bg-gray-800">
      <div class="flex items-center space-x-2">
        <button class="px-3 py-1 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Previous</button>
        <span class="text-sm text-gray-700 dark:text-gray-400">Page ${currentPage} of ${totalPages}</span>
        <button class="px-3 py-1 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Next</button>
      </div>
    </div>`;
    return paginationHTML;
  }
---
<LayoutSidebar class={clazz}>
  <div class="p-4">
    <!-- Breadcrumb -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 text-sm font-medium md:space-x-2">
        {(config as any).breadcrumb.map((item: any, index: number) => (
          <li class={index === 0 ? 'inline-flex items-center' : ''}>
            {index > 0 && (
              <div class="flex items-center">
                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
              </div>
            )}
            {item.path ? (
              <a href={item.path} class="inline-flex items-center text-gray-700 hover:text-primary-600 dark:text-gray-300 dark:hover:text-white">
                {item.label}
              </a>
            ) : (
              <span class="ml-1 text-gray-500 md:ml-2 dark:text-gray-400">{item.label}</span>
            )}
          </li>
        ))}
      </ol>
    </nav>

    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">{(config as any).pluralName}</h1>
        <p class="text-gray-600 dark:text-gray-400">Manage {(config as any).pluralName.toLowerCase()} in system</p>
      </div>
      <div class="flex space-x-2">
        <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
          Add {(config as any).displayName}
        </button>
      </div>
    </div>

    <!-- Search and Filters -->
    {(config as any).search.enabled && (
      <div class="mb-4">
        <div class="relative">
          <input type="text" placeholder={(config as any).search.placeholder} class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
            <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
            </svg>
          </div>
        </div>
      </div>
    )}

    <!-- Table -->
    <div set:html={generateTable(initialData.data, (config as any).columns)} />

    <!-- Pagination -->
    {generatePagination(initialData.page, Math.ceil(initialData.total / initialData.limit))}

    <!-- Bulk Actions Bar (Hidden by default) -->
    <div id="bulk-actions-bar" class="hidden fixed bottom-4 left-4 right-4 p-4 bg-white border border-gray-200 rounded-lg shadow-lg dark:bg-gray-800 dark:border-gray-700">
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-600 dark:text-gray-400">
          <span id="selected-count">0</span> items selected
        </span>
        <div class="flex space-x-2">
          <button onclick="clearSelection()" class="px-3 py-1 text-sm text-gray-600 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-600">
            Clear Selection
          </button>
          <button class="bulk-action-btn px-3 py-1 text-sm text-white bg-yellow-600 border border-yellow-600 rounded-lg hover:bg-yellow-700 dark:bg-yellow-600 dark:border-yellow-600 dark:hover:bg-yellow-700" data-action="bulk-edit">
            Edit Selected
          </button>
          <button class="bulk-action-btn px-3 py-1 text-sm text-white bg-red-600 border border-red-600 rounded-lg hover:bg-red-700 dark:bg-red-600 dark:border-red-600 dark:hover:bg-red-700" data-action="bulk-delete">
            Delete Selected
          </button>
        </div>
      </div>
    </div>
  </div>
</LayoutSidebar>

<script>
  // Simple CRUD management for the new simplified version
  class CrudManager {
    entityType: string;
    selectedIds: Set<string>;
    
    constructor() {
      this.entityType = '{entityType}';
      this.selectedIds = new Set();
    }
    
    init() {
      // Listen for action events
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const btn = target.closest('.action-btn');
        if (btn) {
          const action = btn.getAttribute('data-action');
          const id = btn.getAttribute('data-id');
          this.handleAction(action, id);
        }
        
        const bulkBtn = target.closest('.bulk-action-btn');
        if (bulkBtn) {
          const action = bulkBtn.getAttribute('data-action');
          this.handleBulkAction(action);
        }
      });
      
      // Listen for checkbox changes
      document.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        if (target.type === 'checkbox' && target.value) {
          this.updateSelection(target);
        }
      });
    }
    
    handleAction(action: string | null, id: string | null) {
      if (!action || !id) return;
      
      switch (action) {
        case 'edit':
          console.log('Edit entity:', id);
          // TODO: Implement edit modal
          break;
        case 'delete':
          if (confirm('Are you sure you want to delete this item?')) {
            console.log('Delete entity:', id);
            // TODO: Implement delete
          }
          break;
      }
    }
    
    handleBulkAction(action: string | null) {
      if (!action) return;
      
      const selectedIds = Array.from(this.selectedIds);
      if (selectedIds.length === 0) {
        alert('Please select at least one item');
        return;
      }
      
      switch (action) {
        case 'bulk-edit':
          console.log('Bulk edit:', selectedIds);
          // TODO: Implement bulk edit
          break;
        case 'bulk-delete':
          if (confirm(`Are you sure you want to delete ${selectedIds.length} items?`)) {
            console.log('Bulk delete:', selectedIds);
            // TODO: Implement bulk delete
          }
          break;
      }
    }
    
    updateSelection(checkbox: HTMLInputElement) {
      const id = checkbox.value;
      
      if (checkbox.checked) {
        this.selectedIds.add(id);
      } else {
        this.selectedIds.delete(id);
      }
      
      this.updateBulkActionsBar();
    }
    
    updateBulkActionsBar() {
      const bulkActionsBar = document.getElementById('bulk-actions-bar');
      const selectedCount = document.getElementById('selected-count');
      const selectAllCheckbox = document.getElementById('checkbox-all-search') as HTMLInputElement;
      
      if (selectedCount) {
        selectedCount.textContent = this.selectedIds.size.toString();
      }
      
      if (this.selectedIds.size > 0) {
        bulkActionsBar?.classList.remove('hidden');
        if (selectAllCheckbox) {
          const totalCheckboxes = document.querySelectorAll('input[type="checkbox"]:not(#checkbox-all-search)').length;
          selectAllCheckbox.checked = this.selectedIds.size === totalCheckboxes;
          selectAllCheckbox.indeterminate = this.selectedIds.size > 0 && this.selectedIds.size < totalCheckboxes;
        }
      } else {
        bulkActionsBar?.classList.add('hidden');
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
      }
    }
  }
  
  // Initialize CRUD manager
  document.addEventListener('DOMContentLoaded', () => {
    const crudManager = new CrudManager();
    crudManager.init();
    (window as any).crudManager = crudManager;
  });
  
  // Global function for clearing selection
  (window as any).clearSelection = function() {
    const crudManager = (window as any).crudManager;
    if (crudManager) {
      const selectAllCheckbox = document.getElementById('checkbox-all-search') as HTMLInputElement;
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
      }
      document.querySelectorAll('input[type="checkbox"]:not(#checkbox-all-search)').forEach(checkbox => {
        (checkbox as HTMLInputElement).checked = false;
      });
      crudManager.selectedIds.clear();
      crudManager.updateBulkActionsBar();
    }
  };
</script>

export default CrudGeneric;
