---
import type { EntityConfig, BaseEntity } from '@/entities/types';

interface Props {
  config: EntityConfig;
  data: BaseEntity[];
  pagination?: {
    currentPage: number;
    totalPages: number;
    totalItems: number;
    pageSize: number;
  };
}

const { config, data, pagination } = Astro.props;

// Helper function to generate breadcrumb
function generateBreadcrumb(breadcrumb: EntityConfig['breadcrumb']) {
  return breadcrumb.map((item, index) => {
    const isLast = index === breadcrumb.length - 1;
    const isActive = isLast || !item.path;
    
    return `
      <li class="${index === 0 ? 'inline-flex items-center' : ''}">
        ${index > 0 ? `
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          </div>
        ` : ''}
        ${item.path ? `
          <a href="${item.path}" class="ml-1 text-gray-700 hover:text-primary-600 ${index === 0 ? '' : 'md:ml-2'} dark:text-gray-300 dark:hover:text-white">
            ${item.label}
          </a>
        ` : `
          <span class="ml-1 ${isActive ? 'text-gray-400' : 'text-gray-700 hover:text-primary-600'} ${index === 0 ? '' : 'md:ml-2'} dark:text-gray-${isActive ? '500' : '300'} dark:hover:text-white" ${isActive ? 'aria-current="page"' : ''}>
            ${item.label}
          </span>
        `}
      </li>
    `;
  }).join('');
}

// Helper function to generate table headers
function generateTableHeaders(columns: EntityConfig['columns']) {
  return columns.map(col => `
    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider ${col.width || ''}">
      <div class="flex items-center">
        ${col.label}
        ${col.sortable ? `
          <button class="ml-1 text-gray-400 hover:text-gray-600" data-sort="${col.key}">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12z"/>
              <path d="M15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z"/>
            </svg>
          </button>
        ` : ''}
      </div>
    </th>
  `).join('');
}

// Helper function to generate table rows
function generateTableRows(data: BaseEntity[], columns: EntityConfig['columns']) {
  return data.map((row, index) => `
    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
      <td class="p-4 w-4">
        <div class="flex items-center">
          <input id="checkbox-table-search-${index}" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" value="${row.id}">
          <label for="checkbox-table-search-${index}" class="sr-only">checkbox</label>
        </div>
      </td>
      ${columns.map(col => `
        <td class="px-6 py-4">
          ${generateCellValue(col, row)}
        </td>
      `).join('')}
      <td class="px-6 py-4">
        <div class="flex space-x-2">
          ${generateRowActions(config.actions, row)}
        </div>
      </td>
    </tr>
  `).join('');
}

// Helper function to generate cell value based on type
function generateCellValue(col: any, row: BaseEntity) {
  const value = row[col.key as keyof BaseEntity];
  
  if (col.formatter && typeof col.formatter === 'function') {
    return col.formatter(value, row);
  }
  
  switch (col.type) {
    case 'avatar':
      return value ? `<img src="${value}" alt="Avatar" class="w-10 h-10 rounded-full" />` : '';
    case 'badge':
      const variant = col.badgeVariant ? col.badgeVariant(value) : 'secondary';
      return `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-${variant}-100 text-${variant}-800 dark:bg-${variant}-900 dark:text-${variant}-200">${value}</span>`;
    case 'number':
      return typeof value === 'number' ? value.toLocaleString() : value;
    case 'boolean':
      return value ? '✓' : '✗';
    default:
      return value || '-';
  }
}

// Helper function to generate row actions
function generateRowActions(actions: EntityConfig['actions'], row: BaseEntity) {
  const rowActions = actions.filter(action => ['edit', 'delete', 'view'].includes(action.type));
  
  return rowActions.map(action => `
    <button 
      type="button" 
      class="action-btn inline-flex justify-center p-1 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
      data-action="${action.type}"
      data-id="${row.id}"
      title="${action.label}"
    >
      ${getActionIcon(action.type)}
    </button>
  `).join('');
}

// Helper function to get action icons
function getActionIcon(actionType: string) {
  const icons = {
    edit: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>',
    delete: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
    view: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>'
  };
  return icons[actionType] || '';
}
---

<entities-crud type={config.type}>
  <!-- Header Section -->
  <div class="p-4 bg-white block sm:flex items-center justify-between border-b border-gray-200 lg:mt-1.5 dark:bg-gray-800 dark:border-gray-700">
    <div class="w-full mb-1">
      <div class="mb-4">
        <nav class="flex mb-5" aria-label="Breadcrumb">
          <ol class="inline-flex items-center space-x-1 text-sm font-medium md:space-x-2">
            {generateBreadcrumb(config.breadcrumb)}
          </ol>
        </nav>
        <h1 class="text-xl font-semibold text-gray-900 sm:text-2xl dark:text-white">
          All {config.pluralName}
        </h1>
      </div>
      
      <!-- Search and Actions Bar -->
      <div class="items-center justify-between block sm:flex">
        <div class="flex items-center mb-4 sm:mb-0">
          {config.search.enabled ? `
            <form class="sm:pr-3" action="#" method="GET">
              <label for="${config.type}-search" class="sr-only">Search</label>
              <div class="relative w-48 mt-1 sm:w-64 xl:w-96">
                <input
                  type="text"
                  name="search"
                  id="${config.type}-search"
                  class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                  placeholder="${config.search.placeholder}"
                />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                  </svg>
                </div>
              </div>
            </form>
          ` : ''}
          
          <!-- Filters -->
          ${config.search.filters ? config.search.filters.map(filter => `
            <div class="ml-3">
              <select name="${filter.name}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">
                ${filter.options?.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
              </select>
            </div>
          `).join('') : ''}
        </div>
        
        <!-- Action Buttons -->
        <div class="flex items-center ml-auto space-x-2 sm:space-x-3">
          ${config.actions.filter(action => ['create', 'import', 'export'].includes(action.type)).map(action => `
            <button
              type="button"
              class="action-btn inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-${action.variant || 'primary'}-700 hover:bg-${action.variant || 'primary'}-800 focus:ring-4 focus:ring-${action.variant || 'primary'}-300 dark:bg-${action.variant || 'primary'}-600 dark:hover:bg-${action.variant || 'primary'}-700 dark:focus:ring-${action.variant || 'primary'}-800"
              data-action="${action.type}"
            >
              ${getActionIcon(action.type)}
              ${action.label}
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Bar (shown when items are selected) -->
  <div id="bulk-actions-bar" class="hidden p-4 bg-gray-50 border-b border-gray-200 dark:bg-gray-800 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <span class="text-sm text-gray-600 dark:text-gray-400">
          <span id="selected-count">0</span> items selected
        </span>
      </div>
      <div class="flex space-x-2">
        ${config.actions.filter(action => ['bulk-edit', 'bulk-delete'].includes(action.type)).map(action => `
          <button
            type="button"
            class="bulk-action-btn inline-flex items-center px-3 py-2 text-sm font-medium text-${action.variant === 'danger' ? 'red' : 'yellow'}-700 bg-${action.variant === 'danger' ? 'red' : 'yellow'}-100 rounded-lg hover:bg-${action.variant === 'danger' ? 'red' : 'yellow'}-200 dark:bg-${action.variant === 'danger' ? 'red' : 'yellow'}-900 dark:text-${action.variant === 'danger' ? 'red' : 'yellow'}-300 dark:hover:bg-${action.variant === 'danger' ? 'red' : 'yellow'}-800"
            data-action="${action.type}"
          >
            ${getActionIcon(action.type)}
            ${action.label}
          </button>
        `).join('')}
        <button
          type="button"
          class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-700"
          onclick="clearSelection()"
        >
          Clear Selection
        </button>
      </div>
    </div>
  </div>

  <!-- Table Section -->
  <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
        <tr>
          <th scope="col" class="p-4">
            <div class="flex items-center">
              <input id="checkbox-all-search" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
              <label for="checkbox-all-search" class="sr-only">checkbox</label>
            </div>
          </th>
          {generateTableHeaders(config.columns)}
          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
            Actions
          </th>
        </tr>
      </thead>
      <tbody>
        {generateTableRows(data, config.columns)}
      </tbody>
    </table>
    
    <!-- Empty State -->
    ${data.length === 0 ? `
      <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">No {config.pluralName.toLowerCase()}</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by creating a new ${config.name.toLowerCase()}.</p>
        <div class="mt-6">
          <button type="button" class="action-btn inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" data-action="create">
            ${getActionIcon('create')}
            Add ${config.displayName}
          </button>
        </div>
      </div>
    ` : ''}
  </div>

  <!-- Pagination -->
  {config.pagination.enabled && pagination ? `
    <div class="flex items-center justify-between bg-white px-4 py-3 sm:px-6 border-t border-gray-200 dark:bg-gray-800 dark:border-gray-700">
      <div class="flex justify-between items-center w-full">
        <div>
          <p class="text-sm text-gray-700 dark:text-gray-300">
            Showing
            <span class="font-medium">${(pagination.currentPage - 1) * pagination.pageSize + 1}</span>
            to
            <span class="font-medium">${Math.min(pagination.currentPage * pagination.pageSize, pagination.totalItems)}</span>
            of
            <span class="font-medium">${pagination.totalItems}</span>
            results
          </p>
        </div>
        <div>
          <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            <button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-700" ${pagination.currentPage <= 1 ? 'disabled' : ''}>
              Previous
            </button>
            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300">
              Page ${pagination.currentPage} of ${pagination.totalPages}
            </span>
            <button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-700" ${pagination.currentPage >= pagination.totalPages ? 'disabled' : ''}>
              Next
            </button>
          </nav>
        </div>
      </div>
    </div>
  ` : ''}
</entities-crud>

<script>
  // Enhanced client-side script for CRUD operations
  import { getEntityConfig } from '@/entities';
  
  class CrudPageManager {
    constructor(element) {
      this.element = element;
      this.entityType = element.getAttribute('type');
      this.selectedRows = new Set();
      this.bulkActionsBar = document.getElementById('bulk-actions-bar');
      this.selectedCount = document.getElementById('selected-count');
      
      this.init();
    }
    
    async init() {
      const config = await getEntityConfig(this.entityType);
      this.config = config;
      this.attachEventListeners();
    }
    
    attachEventListeners() {
      // Checkbox handlers
      const selectAllCheckbox = document.getElementById('checkbox-all-search');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => this.handleSelectAll(e));
      }
      
      // Row checkboxes
      this.element.querySelectorAll('input[type="checkbox"]:not(#checkbox-all-search)').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => this.handleRowSelection(e));
      });
      
      // Action buttons
      this.element.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', (e) => this.handleAction(e));
      });
      
      // Bulk action buttons
      this.element.querySelectorAll('.bulk-action-btn').forEach(btn => {
        btn.addEventListener('click', (e) => this.handleBulkAction(e));
      });
    }
    
    handleSelectAll(e) {
      const checked = e.target.checked;
      this.element.querySelectorAll('input[type="checkbox"]:not(#checkbox-all-search)').forEach(checkbox => {
        checkbox.checked = checked;
        const id = checkbox.value;
        if (checked) {
          this.selectedRows.add(id);
        } else {
          this.selectedRows.delete(id);
        }
      });
      this.updateBulkActionsBar();
    }
    
    handleRowSelection(e) {
      const id = e.target.value;
      if (e.target.checked) {
        this.selectedRows.add(id);
      } else {
        this.selectedRows.delete(id);
      }
      this.updateBulkActionsBar();
    }
    
    updateBulkActionsBar() {
      const count = this.selectedRows.size;
      this.selectedCount.textContent = count;
      
      if (count > 0) {
        this.bulkActionsBar.classList.remove('hidden');
      } else {
        this.bulkActionsBar.classList.add('hidden');
      }
    }
    
    handleAction(e) {
      const action = e.currentTarget.dataset.action;
      const id = e.currentTarget.dataset.id;
      
      switch (action) {
        case 'create':
          this.openCreateModal();
          break;
        case 'edit':
          this.openEditModal(id);
          break;
        case 'delete':
          this.confirmDelete(id);
          break;
        case 'view':
          this.viewDetails(id);
          break;
        case 'import':
          this.openImportModal();
          break;
        case 'export':
          this.exportData();
          break;
      }
    }
    
    handleBulkAction(e) {
      const action = e.currentTarget.dataset.action;
      const ids = Array.from(this.selectedRows);
      
      switch (action) {
        case 'bulk-edit':
          this.openBulkEditModal(ids);
          break;
        case 'bulk-delete':
          this.confirmBulkDelete(ids);
          break;
      }
    }
    
    // Placeholder methods - to be implemented
    openCreateModal() {
      console.log('Open create modal for', this.entityType);
    }
    
    openEditModal(id) {
      console.log('Open edit modal for', id, 'of type', this.entityType);
    }
    
    confirmDelete(id) {
      console.log('Confirm delete for', id);
    }
    
    viewDetails(id) {
      console.log('View details for', id);
    }
    
    openImportModal() {
      console.log('Open import modal for', this.entityType);
    }
    
    exportData() {
      console.log('Export data for', this.entityType);
    }
    
    openBulkEditModal(ids) {
      console.log('Open bulk edit modal for', ids);
    }
    
    confirmBulkDelete(ids) {
      console.log('Confirm bulk delete for', ids);
    }
  }
  
  // Initialize the CRUD page manager
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('entities-crud').forEach(element => {
      new CrudPageManager(element);
    });
  });
  
  // Global function for clear selection
  window.clearSelection = function() {
    document.getElementById('checkbox-all-search').checked = false;
    document.querySelectorAll('input[type="checkbox"]:not(#checkbox-all-search)').forEach(checkbox => {
      checkbox.checked = false;
    });
    const manager = document.querySelector('entities-crud').__manager;
    if (manager) {
      manager.selectedRows.clear();
      manager.updateBulkActionsBar();
    }
  };
</script>
